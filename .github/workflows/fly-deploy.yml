# Deploy to Fly.io after CI passes
# See https://fly.io/docs/launch/continuous-deployment-with-github-actions/

name: Fly Deploy

on:
  workflow_run:
    workflows: ["CI"]
    branches: [main]
    types: [completed]

jobs:
  deploy:
    name: Deploy to dev
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    concurrency: deploy-klass-hero-dev
    environment:
      name: dev
      url: https://klass-hero-dev.fly.dev
    steps:
      # actions/checkout@v6.0.2
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      # superfly/flyctl-actions/setup-flyctl@v1.5
      - name: Set up flyctl
        uses: superfly/flyctl-actions/setup-flyctl@fc53c09e1bc3be6f54706524e3b82c4f462f77be

      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
