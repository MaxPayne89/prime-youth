name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ '**' ]

env:
  ELIXIR_VERSION: '1.20.0-rc.1'
  OTP_VERSION: '28.3'

jobs:
  test:
    name: Test & Format Check
    runs-on: ubuntu-latest

    steps:
      # actions/checkout@v6.0.2
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      # Start services using docker-compose
      # hoverkraft-tech/compose-action@v2.4.3
      - name: Start PostgreSQL with docker-compose
        uses: hoverkraft-tech/compose-action@05da55b2bb8a5a759d1c4732095044bd9018c050
        with:
          compose-file: "./docker-compose.yml"
          down-flags: "--volumes"

      # Wait for PostgreSQL to be ready
      - name: Wait for PostgreSQL
        run: |
          timeout 30 bash -c 'until docker exec klass_hero_postgres pg_isready -U postgres; do sleep 1; done'
        timeout-minutes: 1

      # erlef/setup-beam@v1.20.4
      - name: Set up Elixir
        uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}
          version-type: strict

      # actions/cache@v5.0.2
      - name: Restore dependencies cache
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-${{ env.OTP_VERSION }}-${{ env.ELIXIR_VERSION }}-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-${{ env.OTP_VERSION }}-${{ env.ELIXIR_VERSION }}-

      - name: Install dependencies
        run: mix deps.get

      - name: Check code formatting
        run: mix format --check-formatted

      - name: Compile with warnings as errors
        run: mix compile --warnings-as-errors

      - name: Create database
        run: mix ecto.create
        env:
          MIX_ENV: test

      - name: Run migrations
        run: mix ecto.migrate
        env:
          MIX_ENV: test

      - name: Run tests
        run: mix test
        env:
          MIX_ENV: test
